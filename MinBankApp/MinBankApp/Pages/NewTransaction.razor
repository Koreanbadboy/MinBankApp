@page "/NewTransaction"
@using System.Linq
@using MinBankApp.Domain
@using MinBankApp.Interfaces
@inject ITransactionService TransactionService
@inject IAccountService AccountService

<h3>Ny betalning / Överföring</h3>

@if (!_accounts.Any())
{
    <div class="alert alert-warning">
        Inga konton hittades. Skapa först ett konto på <a href="/CreateAccount">CreateAccount</a>.
    </div>
}
else
{
    <EditForm Model="_transferModel" OnValidSubmit="TransferAsync">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Från konto -->
        <div class="mb-2">
            <label>Från konto</label>
            <InputSelect @bind-Value="_transferModel.FromAccountName">
                <option value="">Välj konto...</option>
                @foreach (var a in _accounts)
                {
                    <option value="@a.Name">@a.Name (@a.AccountType) – @a.Currency</option>
                }
            </InputSelect>
        </div>

        <!-- Till konto -->
        <div class="mb-2">
            <label>Till konto</label>
            <InputSelect @bind-Value="_transferModel.ToAccountName">
                <option value="">Välj konto...</option>
                @foreach (var a in _accounts)
                {
                    <option value="@a.Name">@a.Name (@a.AccountType) – @a.Currency</option>
                }
            </InputSelect>
        </div>

        <!-- Belopp -->
        <div class="mb-2">
            <label>Belopp</label>
            <InputNumber @bind-Value="_transferModel.Amount" />
        </div>

        <!-- Beskrivning -->
        <div class="mb-2">
            <label>Beskrivning</label>
            <InputText @bind-Value="_transferModel.Description" />
        </div>

        <button type="submit">Genomför överföring</button>
    </EditForm>
}

@if (_transactions.Any())
{
    <h4 class="mt-4">Alla betalningar</h4>
    @foreach (var t in _transactions.Where(t => t.AccountName == _transferModel.FromAccountName))
    {
        var account = _accounts.FirstOrDefault(a => a.Name == t.AccountName);
        <li>
            @t.Date.ToShortDateString() – <strong>@t.AccountName</strong> – @t.Amount @account?.Currency – @t.Description
        </li>
    }
    
    <!-- transaktionshistorik -->

    <!-- transaktionshistorik -->

    <div class="history-box" style="border:1px solid #ccc; padding:1em; margin-top:2em;">
        <h5>Transaktionshistorik</h5>
        <ul>
            @foreach (var t in _transactions)
            {
                var account = _accounts.FirstOrDefault(a => a.Name == t.AccountName);
                var action = t.Amount < 0 ? "överfört" : "mottagit";
                <li>
                    @t.Date.ToShortDateString() – <strong>@t.AccountName</strong> – @action – @t.Amount @account?.Currency – @t.Description
                </li>
            }
        </ul>
    </div>

    
    

@code {
    // List of accounts
    private List<IBankAccount> _accounts = new();

    // Model for transfer form
    private TransferModel _transferModel = new();

    // List of transactions
    private List<Transaction> _transactions = new();

    // Load accounts and transactions on page load
    protected override async Task OnInitializedAsync()
    {
        // Fetch accounts asynchronously
        _accounts = await AccountService.GetAccounts() ?? new List<IBankAccount>();

        // Fetch saved transactions
        _transactions = await TransactionService.GetAllAsync();
    }

    // Genomför överföring mellan konton
    private async Task TransferAsync()
    {
        await TransactionService.TransferAsync(
            _transferModel.FromAccountName,
            _transferModel.ToAccountName,
            _transferModel.Amount,
            _transferModel.Description
        );
        _transactions = await TransactionService.GetAllAsync();
        _transferModel = new TransferModel(); // reset form
    }


    // Modell för överföring
    public class TransferModel
    {
        public string FromAccountName { get; set; }
        public string ToAccountName { get; set; }
        public decimal Amount { get; set; }
        public string Description { get; set; }
    }
}
}